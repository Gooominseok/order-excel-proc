<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì—‘ì…€ í¬ì¥ ìë™í™”</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .upload-area {
            border: 2px dashed #ced4da; border-radius: 10px; padding: 50px;
            text-align: center; cursor: pointer; background: white; transition: 0.3s;
        }
        .upload-area:hover { border-color: #0d6efd; background-color: #f1f8ff; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark px-3">
    <a class="navbar-brand" href="/">ğŸ“¦ í¬ì¥ ìë™í™”</a>
    <div>
        <a href="/" class="btn btn-outline-light btn-sm me-2">ë°°ì†¡ ì •ë¦¬(ë©”ì¸)</a>
        
        <a href="/settings" class="btn btn-outline-light btn-sm me-2">ì„¤ì • ê´€ë¦¬</a>
        
        <a href="/sales" class="btn btn-warning btn-sm fw-bold">íŒë§¤ëŸ‰ í†µê³„ ğŸ“Š</a>
    </div>
</nav>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card p-4 shadow-sm">
                <h3 class="text-center mb-4">ì—‘ì…€ ë³€í™˜í•˜ê¸°</h3>
                
                <div class="mb-3">
                    <label for="platformSelect" class="form-label fw-bold">í”Œë«í¼ ì„ íƒ</label>
                    <select id="platformSelect" class="form-select">
                        <option th:each="p : ${platforms}" 
                                th:value="${p.name}" 
                                th:text="${p.name}">í”Œë«í¼ëª…</option>
                    </select>
                </div>

                <div class="upload-area mb-3" onclick="document.getElementById('fileInput').click()">
                    <div id="uploadText">
                        <h1 class="text-muted">ğŸ“‚</h1>
                        <p class="mb-0 text-muted">ì—¬ê¸°ë¥¼ í´ë¦­í•˜ì—¬ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                    </div>
                    <input type="file" id="fileInput" style="display: none" accept=".xlsx, .xls, .csv">
                    <p id="fileName" class="text-primary fw-bold mt-2"></p>
                </div>

                <button onclick="uploadFile()" class="btn btn-primary w-100 py-2 fw-bold">ë³€í™˜ ì‹œì‘ ğŸš€</button>
                <div id="status" class="mt-3 text-center fw-bold"></div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('fileInput').addEventListener('change', function() {
        if (this.files.length > 0) {
            document.getElementById('uploadText').style.display = 'none';
            document.getElementById('fileName').innerText = "âœ… ì„ íƒëœ íŒŒì¼: " + this.files[0].name;
        }
    });

    async function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        const platform = document.getElementById('platformSelect').value;
        const statusDiv = document.getElementById('status');

        if (fileInput.files.length === 0) {
            alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
            return;
        }

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        formData.append("platformName", platform);

        statusDiv.innerText = "â³ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.";
        statusDiv.className = "mt-3 text-center fw-bold text-secondary";

        try {
            const response = await fetch('/api/excel/upload', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                const contentDisposition = response.headers.get('Content-Disposition');
                let fileName = 'result.xlsx';
                if (contentDisposition && contentDisposition.indexOf('filename*=') !== -1) {
                    fileName = decodeURIComponent(contentDisposition.split("filename*=UTF-8''")[1]);
                }
                
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                a.remove();
                
                statusDiv.innerText = "âœ… ë³€í™˜ ì™„ë£Œ! ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.";
                statusDiv.className = "mt-3 text-center fw-bold text-success";
            } else {
                statusDiv.innerText = "âŒ ì‹¤íŒ¨: ì„œë²„ ì—ëŸ¬ ë°œìƒ";
                statusDiv.className = "mt-3 text-center fw-bold text-danger";
            }
        } catch (error) {
            console.error(error);
            statusDiv.innerText = "âŒ í†µì‹  ì˜¤ë¥˜: ì„œë²„ ì—°ê²° í™•ì¸ í•„ìš”";
            statusDiv.className = "mt-3 text-center fw-bold text-danger";
        }
    }
</script>
</body>
</html>
