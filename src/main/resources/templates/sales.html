<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>판매량 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark px-3">
    <a class="navbar-brand" href="/">📦 포장 자동화</a>
    <div>
        <a href="/" class="btn btn-outline-light btn-sm me-2">배송 정리</a>
        <a href="/settings" class="btn btn-outline-light btn-sm me-2">설정 관리</a>
        <a href="/sales" class="btn btn-warning btn-sm fw-bold">판매량 통계 📊</a>
    </div>
</nav>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white fw-bold">1. 엑셀 판매량 DB 등록</div>
                <div class="card-body">
                    <p class="text-muted small">정리 완료된 엑셀을 업로드하면, 주문일자별로 상품 판매량이 누적 저장됩니다.</p>
                    <input class="form-control mb-3" type="file" id="dbFiles" multiple accept=".xlsx">
                    <button class="btn btn-success w-100 fw-bold" onclick="uploadToDB()">DB에 저장하기 💾</button>
                    <div id="dbLoading" class="mt-3 text-center" style="display:none;">
                        <div class="spinner-border text-success spinner-border-sm"></div> 저장 중...
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white fw-bold">2. 기간별 상세 판매 내역</div>
                <div class="card-body">
                    <div class="row mb-4 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">시작일</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">종료일</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100 fw-bold" onclick="loadChart()">통계 보기 📊</button>
                        </div>
                    </div>
                    
                    <div class="accordion" id="accordionResult">
                        <div class="text-center text-muted mt-5">
                            기간을 선택하고 통계 보기를 눌러주세요.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. DB 등록 함수 (기존과 동일)
    async function uploadToDB() {
        const fileInput = document.getElementById('dbFiles');
        if (fileInput.files.length === 0) return alert('파일을 선택해주세요!');
        
        const formData = new FormData();
        for (let i = 0; i < fileInput.files.length; i++) {
            formData.append('files', fileInput.files[i]);
        }

        document.getElementById('dbLoading').style.display = 'block';
        try {
            const res = await fetch('/api/excel/sales/upload', { method: 'POST', body: formData });
            if (!res.ok) throw new Error(await res.text());
            alert('✅ 성공적으로 DB에 판매량이 누적되었습니다!');
            fileInput.value = '';
        } catch (e) {
            alert('❌ 저장 실패: ' + e.message);
        } finally {
            document.getElementById('dbLoading').style.display = 'none';
        }
    }

    // 2. 차트 조회 및 토글 목록 생성
    async function loadChart() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        if (!start || !end) return alert('시작일과 종료일을 모두 선택해주세요!');

        try {
            const res = await fetch(`/api/excel/sales/data?startDate=${start}&endDate=${end}`);
            const data = await res.json();
            
            const resultArea = document.getElementById('accordionResult');
            if(data.length === 0) {
                resultArea.innerHTML = '<div class="alert alert-warning">해당 기간에 조회된 데이터가 없습니다.</div>';
                return;
            }

            resultArea.innerHTML = ''; // 기존 목록 초기화

            // 상품마다 하나씩 토글 목록(아코디언)을 만듭니다.
            data.forEach((item, index) => {
                const collapseId = 'collapse_' + index;
                const chartId = 'chart_' + index;
                
                // 목록 HTML 구조 (이름 | 총 판매량)
                const html = `
                <div class="accordion-item mb-2 border rounded">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed py-3" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                            <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                <span class="fw-bold fs-5 text-dark">${index + 1}. ${item.name}</span>
                                <span class="badge bg-primary fs-6 rounded-pill px-3 py-2">총 ${item.totalQty} 개</span>
                            </div>
                        </button>
                    </h2>
                    <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#accordionResult">
                        <div class="accordion-body bg-light">
                            <div style="height: 300px;">
                                <canvas id="${chartId}"></canvas>
                            </div>
                        </div>
                    </div>
                </div>`;
                
                resultArea.insertAdjacentHTML('beforeend', html);
                
                // 차트 그리기 준비 (날짜 순으로 정렬)
                const dates = Object.keys(item.daily).sort();
                const qtys = dates.map(d => item.daily[d]);
                
             	// ★ 여기가 핵심! 콤보 차트 + 라벨 그리기 ★
                const ctx = document.getElementById(chartId).getContext('2d');
                new Chart(ctx, {
                    type: 'bar', // 기본 베이스는 막대그래프
                    data: {
                        labels: dates,
                        datasets: [
                            // [데이터셋 1: 선 그래프 (추세선)]
                            {
                                type: 'line', // 얘는 선으로 그려라
                                label: '추세',
                                data: qtys,
                                borderColor: '#FF6384', // 붉은색 계열 선
                                borderWidth: 2,
                                tension: 0.3, // 부드러운 곡선
                                pointRadius: 0, // 선 위의 점은 숨김 (깔끔하게)
                                fill: false,
                                order: 1, // 레이어 순서 (앞쪽)
                                datalabels: { display: false } // 선에는 라벨 표시 안 함
                            },
                            // [데이터셋 2: 막대 그래프 (판매량)]
                            {
                                type: 'bar', // 얘는 막대로 그려라
                                label: '판매량',
                                data: qtys,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)', // 파란색 막대
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1,
                                order: 2, // 레이어 순서 (뒤쪽)
                                borderRadius: 5 // 막대 모서리 둥글게
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { 
                            y: { beginAtZero: true, ticks: { stepSize: 1 } } 
                        },
                        plugins: {
                            legend: { display: false }, // 범례 숨김 (깔끔하게)
                            // ★ 데이터 라벨 플러그인 설정 ★
                            datalabels: {
                                anchor: 'end',  // 막대의 끝부분(꼭대기)에 위치
                                align: 'top',   // 막대 바깥쪽 위로 정렬
                                offset: 0,      // 간격 조정
                                color: 'black', // 글자색
                                font: {
                                    weight: 'bold', // 굵게
                                    size: '12'      // 글자 크기
                                },
                                // 보여줄 내용 커스텀 (* 표시 추가)
                                formatter: function(value, context) {
                                    // 막대 그래프 데이터셋(index 1)일 때만 표시
                                    if (context.datasetIndex === 1 && value > 0) {
                                        return '* ' + value;
                                    }
                                    return null; // 값이 0이거나 선 그래프면 표시 안 함
                                }
                            }
                        }
                    }
                });
            });

        } catch (e) {
            alert('❌ 조회 실패: ' + e.message);
        }
    }
</script>

</body>
</html>