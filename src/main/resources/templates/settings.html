<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì„¤ì • ê´€ë¦¬ - í¬ì¥ ìë™í™”</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sidebar { min-height: 100vh; background: #f8f9fa; border-right: 1px solid #dee2e6; }
        .rule-table input, .rule-table select { border: none; background: transparent; width: 100%; text-align: center; }
        .rule-table input:focus, .rule-table select:focus { outline: 2px solid #86b7fe; background: white; }
        .card-header { font-weight: bold; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark px-3">
    <a class="navbar-brand" href="/">ğŸ“¦ í¬ì¥ ìë™í™”</a>
    <div>
        <a href="/" class="btn btn-outline-light btn-sm me-2">ë°°ì†¡ ì •ë¦¬(ë©”ì¸)</a>
        
        <a href="/settings" class="btn btn-outline-light btn-sm me-2">ì„¤ì • ê´€ë¦¬</a>
        
        <a href="/sales" class="btn btn-warning btn-sm fw-bold">íŒë§¤ëŸ‰ í†µê³„ ğŸ“Š</a>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 col-lg-2 sidebar p-3">
            <h5 class="mb-3">í”Œë«í¼ ëª©ë¡</h5>
            <div class="list-group" id="platformList"></div>
            <button class="btn btn-success w-100 mt-3" onclick="createNew()">+ ìƒˆ í”Œë«í¼ ì¶”ê°€</button>
        </div>

        <div class="col-md-9 col-lg-10 p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 id="formTitle">ì„¤ì • í¸ì§‘</h3>
                <div>
                    <button class="btn btn-danger me-2" onclick="deletePlatform()" id="btnDelete" style="display:none;">ì‚­ì œ</button>
                    <button class="btn btn-primary" onclick="savePlatform()">ì €ì¥í•˜ê¸° ğŸ’¾</button>
                </div>
            </div>

            <form id="configForm">
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white">1. ê¸°ë³¸ ì •ë³´</div>
                    <div class="card-body row">
                        <div class="col-md-4 mb-3">
                            <label>í”Œë«í¼ ì´ë¦„ (í•„ìˆ˜)</label>
                            <input type="text" class="form-control" id="platformName" placeholder="ì˜ˆ: NAVER">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label>ì—‘ì…€ ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="text" class="form-control" id="excelPassword" placeholder="ì—†ìœ¼ë©´ ë¹„ì›€">
                        </div>
                        <div class="col-md-4 mb-3">
    						<label>íŒŒì¼ëª… ì ‘ë‘ì–´</label>
    						<input type="text" class="form-control" id="filenamePrefix" placeholder="ì˜ˆ: 1.ë””ë””ë©ë°°ì†¡ì •ë¦¬ì—‘ì…€">
						</div>
                        <div class="col-md-4 mb-3">
                            <label>í—¤ë” ìœ„ì¹˜ (í–‰ ë²ˆí˜¸, 1ë¶€í„°)</label>
                            <input type="number" class="form-control" id="headerRowIndex" value="1">
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-info text-white">2. ì»¬ëŸ¼ ë§¤í•‘ (ì—‘ì…€ í—¤ë”ëª… ì…ë ¥)</div>
                    <div class="card-body row">
                        <div class="col-md-3 mb-2"><label>ì£¼ë¬¸ë²ˆí˜¸</label><input type="text" class="form-control" id="col_orderNo"></div>
                        <div class="col-md-3 mb-2"><label>ìˆ˜ì·¨ì¸ëª…</label><input type="text" class="form-control" id="col_receiver"></div>
                        <div class="col-md-3 mb-2"><label>ìˆ˜ëŸ‰</label><input type="text" class="form-control" id="col_qty"></div>
                        
                        <div class="col-md-3 mb-2">
                            <label class="fw-bold text-primary">ìƒí’ˆëª… í›„ë³´ (ì‰¼í‘œêµ¬ë¶„)</label>
                            <input type="text" class="form-control" id="col_productName" placeholder="ì˜ˆ: ì˜µì…˜ì •ë³´,íŒë§¤ì ë‚´ë¶€ì½”ë“œ1,ìƒí’ˆëª…">
                        </div>
                        <div class="col-md-3 mb-2"><label>ë°°ì†¡ë©”ì‹œì§€</label><input type="text" class="form-control" id="col_message"></div>
                        <div class="col-md-3 mb-2"><label>ë°°ì†¡ì§€(ì£¼ì†Œ)</label><input type="text" class="form-control" id="col_address"></div>

                        <div class="col-md-3 mb-2"><label>ì—°ë½ì²˜1</label><input type="text" class="form-control" id="col_contact1"></div>
                        <div class="col-md-3 mb-2"><label class="fw-bold text-danger">ì£¼ë¬¸ì¼ì</label><input type="text" class="form-control" id="col_orderDate" placeholder="ì˜ˆ: ê²°ì œì¼, ì£¼ë¬¸ì¼"></div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark d-flex justify-content-between">
                        <span>3. ìƒí’ˆ ê·œì¹™ (ì´ë¦„ ë³€ê²½ / ìˆ˜ëŸ‰ í•©ì¹˜ê¸° / ìƒ‰ìƒ)</span>
                        <button type="button" class="btn btn-sm btn-light" onclick="addProductRule()">+ ì¶”ê°€</button>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-bordered mb-0 rule-table">
                            <thead>
                                <tr>
                                    <th>í¬í•¨ í‚¤ì›Œë“œ (ì½¤ë§ˆ êµ¬ë¶„)</th>
                                    <th width="150">ìµœì¢… ìƒí’ˆëª…</th>
                                    <th width="80">ìš°ì„ ìˆœìœ„</th>
                                    <th width="100">ìˆ˜ëŸ‰ê·¸ë£¹ëª…</th>
                                    <th width="80">ìƒ‰ìƒ</th>
                                     <th width="80">ì¦ì •ê·œì¹™</th>
                                    <th width=150>ë‹¨ê°€(ì›)</th>
                                    <th width="50">ì‚­ì œ</th>
                                </tr>
                            </thead>
                            <tbody id="productRuleBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-success text-white d-flex justify-content-between">
                        <span>4. ì¦ì • ê·œì¹™ (ìƒí’ˆ Nê°œë‹¹ 1ê°œ)</span>
                        <button type="button" class="btn btn-sm btn-light" onclick="addGiveawayRule()">+ ì¶”ê°€</button>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-bordered mb-0 rule-table">
                            <thead>
                                <tr>
                                    <th width="100">ì¦ì •ê·œì¹™</th>
                                    <th width="150">ì¡°ê±´(N)ê°œë§ˆë‹¤</th>
                                    <th width="150">ì¦ì •(M)ê°œ</th>
                                    <th width="150">ì¦ì •í’ˆ ì´ë¦„</th>
                                    <th width="50">ì‚­ì œ</th>
                                </tr>
                            </thead>
                            <tbody id="giveawayRuleBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between">
                        <span>5. ê¸ˆì•¡ë³„ ì‚¬ì€í’ˆ (ì´ ì£¼ë¬¸ê¸ˆì•¡ ê¸°ì¤€)</span>
                        <button type="button" class="btn btn-sm btn-light" onclick="addPriceGiftRule()">+ ì¶”ê°€</button>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-bordered mb-0 rule-table">
                            <thead>
                                <tr>
                                    <th>ìµœì†Œ ê¸ˆì•¡ (ì›)</th>
                                    <th>ìµœëŒ€ ê¸ˆì•¡ (ì›)</th>
                                    <th>ì‚¬ì€í’ˆ ì´ë¦„</th>
                                    <th width="50">ì‚­ì œ</th>
                                </tr>
                            </thead>
                            <tbody id="priceGiftRuleBody"></tbody>
                        </table>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", loadPlatformList);

    async function loadPlatformList() {
        const res = await fetch('/api/platform/list');
        const list = await res.json();
        const container = document.getElementById('platformList');
        container.innerHTML = '';
        list.forEach(p => {
            const btn = document.createElement('button');
            btn.className = 'list-group-item list-group-item-action';
            btn.innerText = p.name;
            btn.onclick = () => loadDetail(p.name);
            container.appendChild(btn);
        });
    }

 // settings.html ë‚´ì˜ loadDetail í•¨ìˆ˜ë¥¼ ì´ ë‚´ìš©ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”
    async function loadDetail(name) {
        // 1. í•œê¸€ ì´ë¦„ì´ í¬í•¨ëœ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ì•ˆì „í•˜ê²Œ ì¸ì½”ë”©í•˜ì—¬ í˜¸ì¶œí•©ë‹ˆë‹¤.
        const res = await fetch('/api/platform/' + encodeURIComponent(name));
        const data = await res.json();
        
        // 2. ë§Œì•½ ì„œë²„ì—ì„œ ë°ì´í„°ê°€ ë°°ì—´([]) í˜•íƒœë¡œ ë‚ ì•„ì˜¨ë‹¤ë©´ ì²« ë²ˆì§¸ í•­ëª©ì„ ì„ íƒí•©ë‹ˆë‹¤.
        const p = Array.isArray(data) ? data[0] : data;

        if (!p) return alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

        // 3. ê¸°ë³¸ ì •ë³´ ì…ë ¥ (idì™€ ì¼ì¹˜ í™•ì¸)
        document.getElementById('platformName').value = p.name || '';
        // â˜… íŒŒì¼ëª… ì ‘ë‘ì–´ (ì•„ë˜ì—ì„œ HTMLì— ì¹¸ì„ ë§Œë“œì…”ì•¼ í•©ë‹ˆë‹¤)
        if(document.getElementById('filenamePrefix')) {
            document.getElementById('filenamePrefix').value = p.filenamePrefix || '';
        }
        document.getElementById('excelPassword').value = p.excelPassword || '';
        document.getElementById('headerRowIndex').value = (p.headerRowIndex || 0) + 1;

        // 4. ì»¬ëŸ¼ ë§¤í•‘ ì •ë³´ (Map êµ¬ì¡° ì²˜ë¦¬)
        const cm = p.columnMapping || {};
        const cols = ['orderNo', 'receiver', 'qty', 'productName', 'message', 'address', 'contact1','orderDate'];
        cols.forEach(k => {
            const input = document.getElementById('col_' + k);
            if (input) input.value = cm[k] || '';
        });

        // 5. ê° ê·œì¹™ í…Œì´ë¸” ì´ˆê¸°í™” í›„ ë°ì´í„° ì±„ìš°ê¸°
        const p_body = document.getElementById('productRuleBody'); p_body.innerHTML = '';
        (p.productRules || []).forEach(r => addProductRule(r));

        const g_body = document.getElementById('giveawayRuleBody'); g_body.innerHTML = '';
        (p.giveawayRules || []).forEach(r => addGiveawayRule(r));

        const pr_body = document.getElementById('priceGiftRuleBody'); pr_body.innerHTML = '';
        (p.priceGiftRules || []).forEach(r => addPriceGiftRule(r)); 

        // ì‚­ì œ ë²„íŠ¼ í™œì„±í™”
        document.getElementById('btnDelete').style.display = 'inline-block';
    }

    function createNew() {
        document.getElementById('configForm').reset();
        document.getElementById('productRuleBody').innerHTML = '';
        document.getElementById('giveawayRuleBody').innerHTML = '';
        document.getElementById('priceGiftRuleBody').innerHTML = '';
        document.getElementById('btnDelete').style.display = 'none';
        document.getElementById('platformName').focus();
    }

    // â˜… ìƒí’ˆ ê·œì¹™ í–‰ ì¶”ê°€ (ìƒ‰ìƒ í¬í•¨)
    function addProductRule(data = {}) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
        	<td><input type="text" class="p-oname" value="${data.targetProductName || ''}" placeholder="ì˜ˆ: ì—í”„ì”¨ì›,6kg,ì‚¬ì€í’ˆ"></td>
            <td><input type="text" class="p-tname" value="${data.finalProductName || ''}"></td> 
            <td><input type="number" class="p-prio" value="${data.priority || 0}"></td>
            <td><input type="text" class="p-gid" value="${data.qtyGroupId || ''}"></td>
            <td><input type="text" class="p-color" value="${data.highlightColor || ''}" placeholder="RED"></td>
            <td><input type="text" class="p-rid" value="${data.giveawayRuleId || ''}"></td>
            <td><input type="number" class="p-price" value="${data.price || 0}" placeholder="ì˜ˆ: 1000"></td>
            <td class="text-center"><button type="button" class="btn-close" onclick="this.closest('tr').remove()"></button></td>
        `;
        document.getElementById('productRuleBody').appendChild(tr);
    }

    function addGiveawayRule(data = {}) {
        const tr = document.createElement('tr');
        const type = data.conditionType || 'EVERY_N';
        tr.innerHTML = `
            <td><input type="text" class="g-rid" value="${data.ruleId || ''}"></td>
			<td><input type="number" class="g-val" value="${data.conditionValue || 1}"></td>        
            <td><input type="number" class="g-gqty" value="${data.giftQty || 1}"></td>
            <td><input type="text" class="g-name" value="${data.giftName || ''}"></td>
            <td class="text-center"><button type="button" class="btn-close" onclick="this.closest('tr').remove()"></button></td>
        `;
        document.getElementById('giveawayRuleBody').appendChild(tr);
    }

    function addPriceGiftRule(data = {}) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="number" class="pr-min" value="${data.minAmount || 0}"></td>
            <td><input type="number" class="pr-max" value="${data.maxAmount || 9999999}"></td>
            <td><input type="text" class="pr-name" value="${data.giftName || ''}"></td>
            <td class="text-center"><button type="button" class="btn-close" onclick="this.closest('tr').remove()"></button></td>
        `;
        document.getElementById('priceGiftRuleBody').appendChild(tr);
    }

    async function savePlatform() {
        const name = document.getElementById('platformName').value;
        if(!name) return alert("í”Œë«í¼ ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤!");

        const dto = {
            name: name,
            filenamePrefix: document.getElementById('filenamePrefix').value,
            excelPassword: document.getElementById('excelPassword').value,
            headerRowIndex: parseInt(document.getElementById('headerRowIndex').value) - 1,
            columnMapping: {
                orderNo: document.getElementById('col_orderNo').value,
                receiver: document.getElementById('col_receiver').value,
                qty: document.getElementById('col_qty').value,
                message: document.getElementById('col_message').value,
                address: document.getElementById('col_address').value,
                productName: document.getElementById('col_productName').value,
                // â˜… ì¶”ê°€ëœ í•„ë“œë“¤
                contact1: document.getElementById('col_contact1').value,
                orderDate: document.getElementById('col_orderDate').value
            },
            productRules: [],
            giveawayRules: [],
            priceGiftRules: []
        };

        // ìƒí’ˆ ê·œì¹™ ìˆ˜ì§‘ (ìƒ‰ìƒ í¬í•¨)
        document.querySelectorAll('#productRuleBody tr').forEach(tr => {
            dto.productRules.push({
                targetProductName: tr.querySelector('.p-oname').value,
                finalProductName: tr.querySelector('.p-tname').value, 
                priority: parseInt(tr.querySelector('.p-prio').value),
                qtyGroupId: tr.querySelector('.p-gid').value,
                highlightColor: tr.querySelector('.p-color').value, // â˜… ìƒ‰ìƒ ìˆ˜ì§‘
                giveawayRuleId: tr.querySelector('.p-rid').value,
                price: parseInt(tr.querySelector('.p-price').value) || 0
            });
        });

        // ì¦ì • ê·œì¹™ ìˆ˜ì§‘
        document.querySelectorAll('#giveawayRuleBody tr').forEach(tr => {
            dto.giveawayRules.push({
                ruleId: tr.querySelector('.g-rid').value,
                conditionValue: parseInt(tr.querySelector('.g-val').value),
                giftQty: parseInt(tr.querySelector('.g-gqty').value) || 1,
                giftName: tr.querySelector('.g-name').value
            });
        });

        // ê¸ˆì•¡ë³„ ì‚¬ì€í’ˆ ìˆ˜ì§‘
        document.querySelectorAll('#priceGiftRuleBody tr').forEach(tr => {
            dto.priceGiftRules.push({
                minAmount: parseInt(tr.querySelector('.pr-min').value),
                maxAmount: parseInt(tr.querySelector('.pr-max').value),
                giftName: tr.querySelector('.pr-name').value
            });
        });

        const res = await fetch('/api/platform', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dto)
        });

        if(res.ok) {
            alert("âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            loadPlatformList();
        } else {
            alert("âŒ ì €ì¥ ì‹¤íŒ¨");
        }
    }
    
    async function deletePlatform() {
        const name = document.getElementById('platformName').value;
        if(confirm(name + " ì„¤ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            await fetch('/api/platform/' + name, { method: 'DELETE' });
            alert("ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            createNew();
            loadPlatformList();
        }
    }
</script>

</body>
</html>